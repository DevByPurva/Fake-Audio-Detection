<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Deepfake Detector - Audio Authentication</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* Custom font: The Seasons */
      @font-face {
        font-family: "The Seasons";
        src: url("{{ url_for('static', filename='fonts/TheSeasons-Regular.woff2') }}")
            format("woff2"),
          url("{{ url_for('static', filename='fonts/TheSeasons-Regular.woff') }}")
            format("woff");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      :root {
        --primary-color: #14b8a6; /* Vibrant turquoise (energy + freshness) */
        --secondary-color: #0ea5e9; /* Sky blue accent (balance + clarity) */
        --success-color: #10b981; /* Calming green hint for success states */
        --danger-color: #ef4444; /* Red for contrast and alerts */
        --dark-color: #0f172a; /* Deep navy ‚Äì subtle base */
        --light-color: #f8fafc; /* Pure soft white background */
        --bg-gradient-start: #06b6d4; /* Turquoise gradient start */
        --bg-gradient-end: #3b82f6; /* Cool blue gradient end */
        --card-bg: #ffffff;
        --text-primary: #0f172a; /* Dark navy text */
        --text-secondary: #475569; /* Muted blue-gray for secondary text */
        --upload-zone-bg: #f1f5f9;
        --upload-zone-hover: #e0f7fa; /* Soft turquoise hover */
      }

      body.dark-mode {
        --bg-gradient-start: #0f172a; /* Deep blue gradient for dark mode */
        --bg-gradient-end: #1e293b;
        --card-bg: #1e293b;
        --text-primary: #f8fafc; /* Light text */
        --text-secondary: #94a3b8; /* Muted cool gray */
        --upload-zone-bg: #1e293b;
        --upload-zone-hover: #334155;
      }

      body {
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        transition: background 0.3s ease;
      }

      .main-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .header-section {
        text-align: center;
        margin-bottom: 3rem;
        animation: fadeInDown 0.8s ease-out;
      }

      .header-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
      }
      .header-icon i {
        color: var(--secondary-color); /* or any hex like #ffffff */
        text-shadow: 0 2px 8px rgba(0,0,0,0.35);
      }

      .main-title {
        color: white;
        font-size: 2.5rem;
        font-weight: 700;
        font-family: "The Seasons", serif;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        font-weight: 300;
      }

      .upload-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 0.8s ease-out;
        position: relative;
        overflow: hidden;
        transition: background 0.3s ease;
      }

      .upload-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      }

      .upload-zone {
        border: 3px dashed #cbd5e1;
        border-radius: 15px;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: var(--upload-zone-bg);
        position: relative;
      }

      .upload-zone:hover {
        border-color: var(--primary-color);
        background: var(--upload-zone-hover);
        transform: translateY(-2px);
      }

      .upload-zone.dragover {
        border-color: var(--primary-color);
        background: #e0e7ff;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
      }

      .file-input {
        display: none;
      }

      .file-name {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #e0e7ff;
        border-radius: 10px;
        color: var(--primary-color);
        font-weight: 500;
        display: none;
      }

      .analyze-btn {
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        border: none;
        padding: 1rem 3rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 50px;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(244, 182, 194, 0.35);
        margin-top: 2rem;
        width: 100%;
      }

      .analyze-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
      }

      .analyze-btn:active {
        transform: translateY(-1px);
      }

      .analyze-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .features-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 3rem;
      }

      .feature-card {
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        animation: fadeInUp 0.8s ease-out;
      }

      .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      }

      .feature-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .feature-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
      }

      .feature-desc {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        flex-wrap: wrap;
      }

      .action-btn {
        padding: 0.75rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .action-btn-logs {
        background: white;
        color: var(--primary-color);
      }

      .action-btn-blockchain {
        background: white;
        color: var(--secondary-color);
      }

      .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .alert {
        border-radius: 15px;
        border: none;
        padding: 1.25rem;
        animation: slideInDown 0.5s ease-out;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .alert-success {
        background: linear-gradient(
          135deg,
          var(--success-color) 0%,
          var(--secondary-color) 100%
        );
        color: white;
      }

      .alert-danger {
        background: linear-gradient(
          135deg,
          var(--danger-color) 0%,
          #dc2626 100%
        );
        color: white;
      }

      .spinner {
        display: none;
        margin: 0 auto;
      }

      .loading .spinner {
        display: block;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .theme-toggle {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: white;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .theme-toggle i {
        font-size: 1.2rem;
      }

      .audio-player-container {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: var(--upload-zone-bg);
        border-radius: 15px;
        display: none;
        animation: fadeInUp 0.5s ease-out;
      }

      .audio-player-container.show {
        display: block;
      }

      .audio-player {
        width: 100%;
        border-radius: 10px;
        outline: none;
      }

      .audio-player::-webkit-media-controls-panel {
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
      }

      .audio-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        color: var(--text-primary);
      }

      .audio-icon {
        font-size: 2rem;
        color: var(--primary-color);
      }

      .audio-details h4 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-primary);
      }

      .audio-details p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .recording-section {
        margin-top: 2rem;
        padding: 2rem;
        background: var(--upload-zone-bg);
        border-radius: 15px;
        text-align: center;
      }

      .recording-title {
        color: var(--text-primary);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .recording-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
      }

      .record-btn {
        padding: 1rem 2rem;
        border-radius: 50px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .record-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      .record-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-start-record {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .btn-stop-record {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: white;
      }

      .btn-play-recording {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .btn-use-recording {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
      }

      .recording-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--card-bg);
        border-radius: 50px;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .recording-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ef4444;
        animation: pulse-dot 1.5s infinite;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      .recording-timer {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: "Courier New", monospace;
        margin: 1rem 0;
      }

      /* Circular progress ring for recording countdown */
      .progress-ring {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: conic-gradient(var(--primary-color) 0deg, #e5e7eb 0deg);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem auto;
        position: relative;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .progress-ring::after {
        content: "";
        position: absolute;
        width: 64px;
        height: 64px;
        background: var(--upload-zone-bg);
        border-radius: 50%;
      }

      .progress-ring span {
        position: relative;
        font-weight: 700;
        color: var(--text-primary);
        font-family: "Courier New", monospace;
      }

      .waveform-container {
        width: 100%;
        height: 100px;
        background: var(--card-bg);
        border-radius: 10px;
        margin: 1rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Shimmer placeholder while initializing microphone */
      .waveform-container.shimmer {
        position: relative;
        background: linear-gradient(
          90deg,
          #f3f4f6 25%,
          #e5e7eb 37%,
          #f3f4f6 63%
        );
        background-size: 400% 100%;
        animation: shimmer 1.2s ease-in-out infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: 100% 0;
        }
        100% {
          background-position: 0 0;
        }
      }

      .waveform-bar {
        width: 3px;
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        margin: 0 2px;
        border-radius: 3px;
        transition: height 0.1s ease;
      }

      .recording-info {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 1rem;
      }

      .divider {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 2rem 0;
        color: var(--text-secondary);
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        border-bottom: 2px solid var(--text-secondary);
        opacity: 0.3;
      }

      .divider span {
        padding: 0 1rem;
        font-weight: 600;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .main-title {
          font-size: 2rem;
        }

        .upload-card {
          padding: 2rem 1.5rem;
        }

        .features-section {
          grid-template-columns: 1fr;
        }

        .theme-toggle {
          top: 1rem;
          right: 1rem;
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
        }

        .recording-controls {
          flex-direction: column;
        }

        .record-btn {
          width: 100%;
        }

        .recording-timer {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Theme Toggle -->
      <div class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon" id="themeIcon"></i>
        <span id="themeText">Dark</span>
      </div>

      <!-- Header Section -->
      <div class="header-section">
        <div class="header-icon">
          <i class="fas fa-microphone-alt"></i>
        </div>
        <h1 class="main-title">VAANI</h1>
        <p class="subtitle">Audio Authentication System</p>
      </div>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% if message is iterable and message is not string %}
              {% for msg in message %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                  <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }} me-2"></i>
                  <div>{{ msg }}</div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
              </div>
              {% endfor %}
            {% else %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                  <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }} me-2"></i>
                  <div>{{ message }}</div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Upload Card -->
      <div class="upload-card">
        <form
          method="POST"
          action="{{ url_for('handle_upload') }}"
          enctype="multipart/form-data"
          id="uploadForm"
        >
          <div class="upload-zone" id="uploadZone">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <h3 style="color: var(--dark-color); margin-bottom: 0.5rem">
              Drop your audio file here
            </h3>
            <p style="color: #64748b; margin-bottom: 1rem">
              or click to browse
            </p>
            <input
              class="file-input"
              type="file"
              id="file"
              name="file"
              accept=".wav"
            />
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="document.getElementById('file').click()"
            >
              <i class="fas fa-folder-open me-2"></i>Choose File
            </button>
            <div class="file-name" id="fileName"></div>
          </div>

          <!-- Divider -->
          <div class="divider">
            <span>OR</span>
          </div>

          <!-- Recording Section -->
          <div class="recording-section">
            <div class="recording-title">
              <i class="fas fa-microphone"></i>
              Record Audio
            </div>

            <div
              id="recordingStatus"
              class="recording-status"
              style="display: none"
            >
              <span class="recording-dot"></span>
              Recording...
            </div>

            <div class="recording-timer" id="recordingTimer">00:00</div>

            <div
              id="recordingProgress"
              class="progress-ring"
              style="display: none"
            >
              <span id="recordingCountdown">30s</span>
            </div>

            <div class="waveform-container" id="waveformContainer">
              <p style="color: var(--text-secondary); margin: 0">
                Audio waveform will appear here
              </p>
            </div>

            <div class="recording-controls">
              <button
                type="button"
                class="record-btn btn-start-record"
                id="startRecordBtn"
              >
                <i class="fas fa-circle"></i>
                Start Recording
              </button>
              <button
                type="button"
                class="record-btn btn-stop-record"
                id="stopRecordBtn"
                disabled
              >
                <i class="fas fa-stop"></i>
                Stop Recording
              </button>
              <button
                type="button"
                class="record-btn btn-play-recording"
                id="playRecordingBtn"
                disabled
              >
                <i class="fas fa-play"></i>
                Play Recording
              </button>
              <button
                type="button"
                class="record-btn btn-use-recording"
                id="useRecordingBtn"
                disabled
              >
                <i class="fas fa-check"></i>
                Use This Recording
              </button>
            </div>

            <div class="recording-info">
              <i class="fas fa-info-circle"></i>
              Click "Start Recording" to record audio from your microphone
            </div>
          </div>

          <!-- Audio Player -->
          <div class="audio-player-container" id="audioPlayerContainer">
            <div class="audio-info">
              <i class="fas fa-music audio-icon"></i>
              <div class="audio-details">
                <h4>Audio Preview</h4>
                <p id="audioFileName">No file selected</p>
              </div>
            </div>
            <audio id="audioPlayer" class="audio-player" controls>
              Your browser does not support the audio element.
            </audio>
          </div>

          <button class="analyze-btn" type="submit" id="analyzeBtn">
            <i class="fas fa-brain me-2"></i>Analyze Audio
          </button>

          <div
            class="spinner-border text-primary spinner"
            role="status"
            id="spinner"
          >
            <span class="visually-hidden">Loading...</span>
          </div>
        </form>
      </div>

      <!-- Features Section -->
      <div class="features-section">
        <div class="feature-card" style="animation-delay: 0.1s">
          <div class="feature-icon">
            <i class="fas fa-bolt"></i>
          </div>
          <div class="feature-title">Lightning Fast</div>
          <div class="feature-desc">Results in under 1 seconds</div>
        </div>

        <div class="feature-card" style="animation-delay: 0.2s">
          <div class="feature-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <div class="feature-title">High Accuracy</div>
          <div class="feature-desc">100% test accuracy on AI speech</div>
        </div>

        <div class="feature-card" style="animation-delay: 0.3s">
          <div class="feature-icon">
            <i class="fas fa-link"></i>
          </div>
          <div class="feature-title">Blockchain Secured</div>
          <div class="feature-desc">Immutable audit trail</div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <a href="{{ url_for('logs') }}" class="action-btn action-btn-logs">
          <i class="fas fa-history"></i>
          View Detection History
        </a>
        <a
          href="{{ url_for('view_blockchain') }}"
          class="action-btn action-btn-blockchain"
        >
          <i class="fas fa-cubes"></i>
          View Blockchain
        </a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // File input handling
      const fileInput = document.getElementById("file");
      const uploadZone = document.getElementById("uploadZone");
      const fileName = document.getElementById("fileName");
      const uploadForm = document.getElementById("uploadForm");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const spinner = document.getElementById("spinner");
      const MAX_RECORDING_SECONDS = 30;

      // Click to upload
      uploadZone.addEventListener("click", (e) => {
        if (e.target !== fileInput && !e.target.closest("button")) {
          fileInput.click();
        }
      });

      // File selected
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          if (!isWavFile(file)) {
            alert("Please upload a valid WAV file.");
            fileInput.value = "";
            fileName.style.display = "none";
            return;
          }
          fileName.textContent = `üìÅ ${file.name} (${(file.size / 1024).toFixed(
            2
          )} KB)`;
          fileName.style.display = "block";

          // Show audio player
          const audioPlayerContainer = document.getElementById(
            "audioPlayerContainer"
          );
          const audioPlayer = document.getElementById("audioPlayer");
          const audioFileName = document.getElementById("audioFileName");

          const fileURL = URL.createObjectURL(file);
          audioPlayer.src = fileURL;
          audioFileName.textContent = file.name;
          audioPlayerContainer.classList.add("show");
        }
      });

      // Drag and drop
      uploadZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadZone.classList.add("dragover");
      });

      uploadZone.addEventListener("dragleave", () => {
        uploadZone.classList.remove("dragover");
      });

      uploadZone.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadZone.classList.remove("dragover");

        if (e.dataTransfer.files.length > 0) {
          const file = e.dataTransfer.files[0];
          if (isWavFile(file)) {
            fileInput.files = e.dataTransfer.files;
            fileName.textContent = `üìÅ ${file.name} (${(
              file.size / 1024
            ).toFixed(2)} KB)`;
            fileName.style.display = "block";

            // Show audio player
            const audioPlayerContainer = document.getElementById(
              "audioPlayerContainer"
            );
            const audioPlayer = document.getElementById("audioPlayer");
            const audioFileName = document.getElementById("audioFileName");

            const fileURL = URL.createObjectURL(file);
            audioPlayer.src = fileURL;
            audioFileName.textContent = file.name;
            audioPlayerContainer.classList.add("show");
          } else {
            alert("Please upload a WAV file");
          }
        }
      });

      function isWavFile(file) {
        const nameOk = file.name && file.name.toLowerCase().endsWith(".wav");
        const typeOk =
          !file.type ||
          file.type === "audio/wav" ||
          file.type === "audio/x-wav" ||
          file.type === "audio/wave";
        return nameOk && typeOk;
      }

      // Form submission
      uploadForm.addEventListener("submit", () => {
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
        uploadForm.classList.add("loading");
      });

      // Auto-dismiss alerts
      setTimeout(() => {
        const alerts = document.querySelectorAll(".alert");
        alerts.forEach((alert) => {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        });
      }, 5000);

      // Audio Recording Functionality
      let mediaRecorder;
      let audioChunks = [];
      let recordedBlob;
      let playbackAudio;
      let recordingInterval;
      let recordingSeconds = 0;
      let audioContext;
      let analyser;
      let dataArray;
      let animationId;
      let audioStream;
      let recordingSource;
      let firstVisualized = false;

      const startRecordBtn = document.getElementById("startRecordBtn");
      const stopRecordBtn = document.getElementById("stopRecordBtn");
      const playRecordingBtn = document.getElementById("playRecordingBtn");
      const useRecordingBtn = document.getElementById("useRecordingBtn");
      const recordingStatus = document.getElementById("recordingStatus");
      const recordingTimer = document.getElementById("recordingTimer");
      const waveformContainer = document.getElementById("waveformContainer");

      // Convert audio to WAV format
      function encodeWAV(samples, sampleRate) {
        const buffer = new ArrayBuffer(44 + samples.length * 2);
        const view = new DataView(buffer);

        // WAV header
        writeString(view, 0, "RIFF");
        view.setUint32(4, 36 + samples.length * 2, true);
        writeString(view, 8, "WAVE");
        writeString(view, 12, "fmt ");
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, 1, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);
        writeString(view, 36, "data");
        view.setUint32(40, samples.length * 2, true);

        // Write audio data
        floatTo16BitPCM(view, 44, samples);

        return new Blob([view], { type: "audio/wav" });
      }

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      function floatTo16BitPCM(view, offset, input) {
        for (let i = 0; i < input.length; i++, offset += 2) {
          const s = Math.max(-1, Math.min(1, input[i]));
          view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
        }
      }

      // Start Recording
      startRecordBtn.addEventListener("click", async () => {
        try {
          // Show shimmer while initializing microphone
          waveformContainer.classList.add("shimmer");
          firstVisualized = false;

          audioStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 44100,
            },
          });

          // Setup audio context for recording and visualization
          audioContext = new (window.AudioContext || window.webkitAudioContext)(
            { sampleRate: 44100 }
          );
          recordingSource = audioContext.createMediaStreamSource(audioStream);

          // Setup analyzer for visualization
          analyser = audioContext.createAnalyser();
          recordingSource.connect(analyser);
          analyser.fftSize = 256;
          const bufferLength = analyser.frequencyBinCount;
          dataArray = new Uint8Array(bufferLength);

          // Setup ScriptProcessor for recording
          const bufferSize = 4096;
          const recorder = audioContext.createScriptProcessor(bufferSize, 1, 1);
          audioChunks = [];

          recorder.onaudioprocess = (e) => {
            const inputData = e.inputBuffer.getChannelData(0);
            audioChunks.push(new Float32Array(inputData));
          };

          recordingSource.connect(recorder);
          recorder.connect(audioContext.destination);

          recordingSeconds = 0;

          // Store recorder for stopping
          window.audioRecorder = recorder;

          // Update UI
          startRecordBtn.disabled = true;
          stopRecordBtn.disabled = false;
          recordingStatus.style.display = "inline-flex";
          // Show countdown/progress ring
          const recordingProgress =
            document.getElementById("recordingProgress");
          const recordingCountdown =
            document.getElementById("recordingCountdown");
          recordingProgress.style.display = "inline-flex";
          updateProgressRing(0);
          recordingCountdown.textContent = `${MAX_RECORDING_SECONDS}s`;

          // Start timer
          recordingInterval = setInterval(() => {
            recordingSeconds++;
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
            recordingTimer.textContent = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            // Update progress ring and countdown
            const pct = Math.min(recordingSeconds / MAX_RECORDING_SECONDS, 1);
            updateProgressRing(pct);
            const remaining = Math.max(
              MAX_RECORDING_SECONDS - recordingSeconds,
              0
            );
            recordingCountdown.textContent = `${remaining}s`;

            // Auto-stop at max duration
            if (recordingSeconds >= MAX_RECORDING_SECONDS) {
              stopRecordBtn.click();
            }
          }, 1000);

          // Start waveform visualization
          visualizeWaveform();
        } catch (error) {
          console.error("Error accessing microphone:", error);
          alert(
            "Could not access microphone. Please ensure you have granted microphone permissions."
          );
        }
      });

      // Stop Recording
      stopRecordBtn.addEventListener("click", () => {
        if (window.audioRecorder && audioStream) {
          // Stop recording
          window.audioRecorder.disconnect();
          recordingSource.disconnect();

          // Stop all tracks
          audioStream.getTracks().forEach((track) => track.stop());

          // Merge all audio chunks
          let totalLength = 0;
          audioChunks.forEach((chunk) => {
            totalLength += chunk.length;
          });

          const mergedAudio = new Float32Array(totalLength);
          let offset = 0;
          audioChunks.forEach((chunk) => {
            mergedAudio.set(chunk, offset);
            offset += chunk.length;
          });

          // Convert to WAV
          recordedBlob = encodeWAV(mergedAudio, audioContext.sampleRate);

          clearInterval(recordingInterval);
          cancelAnimationFrame(animationId);

          // Update UI
          startRecordBtn.disabled = false;
          stopRecordBtn.disabled = true;
          recordingStatus.style.display = "none";
          playRecordingBtn.disabled = false;
          useRecordingBtn.disabled = false;
          // Finalize progress ring to full
          updateProgressRing(1);

          // Reset playback audio for new recording
          if (playbackAudio) {
            try {
              playbackAudio.pause();
            } catch (e) {}
            playbackAudio = null;
          }
          playRecordingBtn.innerHTML =
            '<i class="fas fa-play"></i>\n            Play Recording';

          // Clean up
          window.audioRecorder = null;
        }
      });

      // Play/Pause Recording (toggle)
      playRecordingBtn.addEventListener("click", () => {
        if (!recordedBlob) return;
        if (!playbackAudio) {
          playbackAudio = new Audio(URL.createObjectURL(recordedBlob));
          playbackAudio.addEventListener("ended", () => {
            playRecordingBtn.innerHTML =
              '<i class="fas fa-play"></i>\n                Play Recording';
          });
        }
        if (playbackAudio.paused) {
          playbackAudio.play();
          playRecordingBtn.innerHTML =
            '<i class="fas fa-pause"></i>\n              Pause';
        } else {
          playbackAudio.pause();
          playRecordingBtn.innerHTML =
            '<i class="fas fa-play"></i>\n              Play Recording';
        }
      });

      // Use Recording
      useRecordingBtn.addEventListener("click", () => {
        if (recordedBlob) {
          // Create a File object from the Blob
          const file = new File([recordedBlob], `recording_${Date.now()}.wav`, {
            type: "audio/wav",
          });

          // Create a DataTransfer object to set the file input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;

          // Show file name
          fileName.textContent = `üìÅ ${file.name} (${(file.size / 1024).toFixed(
            2
          )} KB)`;
          fileName.style.display = "block";

          // Show audio player
          const audioPlayerContainer = document.getElementById(
            "audioPlayerContainer"
          );
          const audioPlayer = document.getElementById("audioPlayer");
          const audioFileName = document.getElementById("audioFileName");

          const fileURL = URL.createObjectURL(file);
          audioPlayer.src = fileURL;
          audioFileName.textContent = file.name;
          audioPlayerContainer.classList.add("show");

          // Scroll to audio player
          audioPlayerContainer.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
          });

          alert("‚úÖ Recording ready! You can now analyze it.");
        }
      });

      // Visualize Waveform
      function visualizeWaveform() {
        if (!analyser) return;

        analyser.getByteFrequencyData(dataArray);

        // Clear previous bars
        waveformContainer.innerHTML = "";
        // Remove shimmer once we start visualizing
        if (!firstVisualized) {
          waveformContainer.classList.remove("shimmer");
          firstVisualized = true;
        }

        // Create bars
        const barCount = 40;
        const step = Math.floor(dataArray.length / barCount);

        for (let i = 0; i < barCount; i++) {
          const value = dataArray[i * step];
          const height = (value / 255) * 80 + 10; // Scale to 10-90px

          const bar = document.createElement("div");
          bar.className = "waveform-bar";
          bar.style.height = `${height}px`;
          waveformContainer.appendChild(bar);
        }

        animationId = requestAnimationFrame(visualizeWaveform);
      }

      function updateProgressRing(ratio) {
        const deg = Math.round(360 * ratio);
        const ring = document.getElementById("recordingProgress");
        if (ring) {
          ring.style.background = `conic-gradient(var(--primary-color) ${deg}deg, #e5e7eb ${deg}deg)`;
        }
      }

      // Theme toggle
      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");
      const themeText = document.getElementById("themeText");
      const body = document.body;

      // Check for saved theme preference
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        body.classList.add("dark-mode");
        themeIcon.classList.remove("fa-moon");
        themeIcon.classList.add("fa-sun");
        themeText.textContent = "Light";
      }

      themeToggle.addEventListener("click", () => {
        body.classList.toggle("dark-mode");

        if (body.classList.contains("dark-mode")) {
          themeIcon.classList.remove("fa-moon");
          themeIcon.classList.add("fa-sun");
          themeText.textContent = "Light";
          localStorage.setItem("theme", "dark");
        } else {
          themeIcon.classList.remove("fa-sun");
          themeIcon.classList.add("fa-moon");
          themeText.textContent = "Dark";
          localStorage.setItem("theme", "light");
        }
      });
    </script>
  </body>
</html>
